<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTTP Client Guide - @oxog/kit</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="../" class="nav-logo">@oxog/kit</a>
      <ul class="nav-menu">
        <li><a href="../#getting-started">Getting Started</a></li>
        <li><a href="../#modules">Modules</a></li>
        <li><a href="../api/">API Reference</a></li>
        <li><a href="./">Guides</a></li>
        <li><a href="https://github.com/oxog/kit" target="_blank">GitHub</a></li>
      </ul>
    </div>
  </nav>

  <main class="container api-content">
    <div class="api-header">
      <h1>HTTP Client Guide</h1>
      <p>Make HTTP requests with interceptors, retry, and more</p>
    </div>

    <section class="section">
      <h2>Basic Usage</h2>
      <pre><code class="language-typescript">import { http } from '@oxog/kit/network';

// GET request
const response = await http.get('https://api.example.com/users');
console.log(response.data);    // Parsed JSON
console.log(response.status);  // 200
console.log(response.headers); // Headers object

// POST request
const created = await http.post('https://api.example.com/users', {
  name: 'John',
  email: 'john@example.com',
});

// PUT, PATCH, DELETE
await http.put('/users/123', { name: 'Jane' });
await http.patch('/users/123', { name: 'Jane' });
await http.delete('/users/123');</code></pre>
    </section>

    <section class="section">
      <h2>Custom Client</h2>
      <pre><code class="language-typescript">import { createHttpClient } from '@oxog/kit/network';

const api = createHttpClient({
  baseURL: 'https://api.example.com',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
    'X-API-Version': '2',
  },
});

// All requests use the base URL and defaults
const users = await api.get('/users');
const user = await api.get('/users/123');
const created = await api.post('/users', { name: 'John' });</code></pre>
    </section>

    <section class="section">
      <h2>Request Options</h2>
      <pre><code class="language-typescript">// Query parameters
const response = await http.get('/users', {
  params: {
    page: 1,
    limit: 10,
    sort: 'createdAt',
  },
});
// GET /users?page=1&limit=10&sort=createdAt

// Custom headers
const response = await http.get('/data', {
  headers: {
    'Authorization': 'Bearer token',
    'Accept-Language': 'en-US',
  },
});

// Timeout
const response = await http.get('/slow-endpoint', {
  timeout: 30000, // 30 seconds
});

// Abort signal
const controller = new AbortController();
setTimeout(() => controller.abort(), 5000);

const response = await http.get('/data', {
  signal: controller.signal,
});</code></pre>
    </section>

    <section class="section">
      <h2>Request Interceptors</h2>
      <pre><code class="language-typescript">import { createHttpClient, createAuthInterceptor } from '@oxog/kit/network';

const api = createHttpClient({ baseURL: 'https://api.example.com' });

// Add authorization header
api.addRequestInterceptor((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    return {
      ...config,
      headers: {
        ...config.headers,
        'Authorization': `Bearer ${token}`,
      },
    };
  }
  return config;
});

// Or use built-in auth interceptor
api.addRequestInterceptor(createAuthInterceptor({
  type: 'bearer',
  token: () => localStorage.getItem('accessToken'),
}));

// Add request ID
api.addRequestInterceptor((config) => ({
  ...config,
  headers: {
    ...config.headers,
    'X-Request-ID': crypto.randomUUID(),
  },
}));</code></pre>
    </section>

    <section class="section">
      <h2>Response Interceptors</h2>
      <pre><code class="language-typescript">// Log responses
api.addResponseInterceptor((response) => {
  console.log(`${response.config.method} ${response.config.url}: ${response.status}`);
  return response;
});

// Transform response data
api.addResponseInterceptor((response) => {
  // Unwrap data envelope
  if (response.data?.data) {
    return {
      ...response,
      data: response.data.data,
    };
  }
  return response;
});

// Handle pagination
api.addResponseInterceptor((response) => {
  const pagination = response.headers.get('X-Pagination');
  if (pagination) {
    return {
      ...response,
      data: {
        items: response.data,
        pagination: JSON.parse(pagination),
      },
    };
  }
  return response;
});</code></pre>
    </section>

    <section class="section">
      <h2>Error Handling</h2>
      <pre><code class="language-typescript">import { createHttpClient, createRetryInterceptor } from '@oxog/kit/network';

const api = createHttpClient({ baseURL: 'https://api.example.com' });

// Add retry on failure
api.addErrorInterceptor(createRetryInterceptor({
  retries: 3,
  retryDelay: (attempt) => Math.min(1000 * Math.pow(2, attempt), 30000),
  retryCondition: (error) => {
    // Retry on network errors
    if (error.code === 'ENETWORK' || error.code === 'ETIMEOUT') {
      return true;
    }
    // Retry on 5xx errors
    if (error.response?.status >= 500) {
      return true;
    }
    return false;
  },
}));

// Handle errors
try {
  const response = await api.get('/data');
} catch (error) {
  if (error.code === 'ETIMEOUT') {
    console.log('Request timed out');
  } else if (error.response) {
    // Server responded with error
    console.log(`Error ${error.response.status}: ${error.response.data.message}`);
  } else {
    // Network error
    console.log('Network error:', error.message);
  }
}</code></pre>
    </section>

    <section class="section">
      <h2>Token Refresh</h2>
      <pre><code class="language-typescript">const api = createHttpClient({ baseURL: 'https://api.example.com' });

let isRefreshing = false;
let refreshSubscribers: ((token: string) => void)[] = [];

function subscribeTokenRefresh(cb: (token: string) => void) {
  refreshSubscribers.push(cb);
}

function onTokenRefreshed(token: string) {
  refreshSubscribers.forEach(cb => cb(token));
  refreshSubscribers = [];
}

// Auth interceptor
api.addRequestInterceptor(createAuthInterceptor({
  type: 'bearer',
  token: () => localStorage.getItem('accessToken'),
}));

// Handle 401 errors
api.addErrorInterceptor(async (error) => {
  if (error.response?.status !== 401) {
    throw error;
  }

  if (isRefreshing) {
    // Wait for token refresh
    return new Promise((resolve) => {
      subscribeTokenRefresh((token) => {
        error.config.headers = {
          ...error.config.headers,
          'Authorization': `Bearer ${token}`,
        };
        resolve(api.request(error.config));
      });
    });
  }

  isRefreshing = true;

  try {
    const refreshToken = localStorage.getItem('refreshToken');
    const response = await http.post('/auth/refresh', { refreshToken });

    const { accessToken, refreshToken: newRefreshToken } = response.data;
    localStorage.setItem('accessToken', accessToken);
    localStorage.setItem('refreshToken', newRefreshToken);

    onTokenRefreshed(accessToken);

    // Retry original request
    error.config.headers = {
      ...error.config.headers,
      'Authorization': `Bearer ${accessToken}`,
    };
    return api.request(error.config);
  } catch (refreshError) {
    // Refresh failed, logout user
    localStorage.clear();
    window.location.href = '/login';
    throw refreshError;
  } finally {
    isRefreshing = false;
  }
});</code></pre>
    </section>

    <section class="section">
      <h2>File Upload</h2>
      <pre><code class="language-typescript">// Upload with FormData
async function uploadFile(file: File) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('description', 'My file');

  const response = await http.post('/upload', formData, {
    headers: {
      // Don't set Content-Type, let browser set it with boundary
    },
  });

  return response.data;
}

// Upload with progress (using native fetch)
async function uploadWithProgress(file: File, onProgress: (percent: number) => void) {
  const formData = new FormData();
  formData.append('file', file);

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();

    xhr.upload.onprogress = (event) => {
      if (event.lengthComputable) {
        const percent = (event.loaded / event.total) * 100;
        onProgress(percent);
      }
    };

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(JSON.parse(xhr.responseText));
      } else {
        reject(new Error(`Upload failed: ${xhr.status}`));
      }
    };

    xhr.onerror = () => reject(new Error('Upload failed'));

    xhr.open('POST', '/upload');
    xhr.send(formData);
  });
}</code></pre>
    </section>

    <section class="section">
      <h2>Response Types</h2>
      <pre><code class="language-typescript">// JSON (default)
const json = await http.get('/data');
console.log(json.data); // Parsed object

// Text
const text = await http.get('/text', {
  responseType: 'text',
});
console.log(text.data); // String

// Blob
const blob = await http.get('/image.png', {
  responseType: 'blob',
});
const url = URL.createObjectURL(blob.data);

// ArrayBuffer
const buffer = await http.get('/binary', {
  responseType: 'arrayBuffer',
});
const view = new Uint8Array(buffer.data);</code></pre>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <p>@oxog/kit - MIT License</p>
    </div>
  </footer>

  <script src="../js/main.js"></script>
</body>
</html>
