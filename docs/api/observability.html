<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Observability Module - @oxog/kit</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="../" class="nav-logo">@oxog/kit</a>
      <ul class="nav-menu">
        <li><a href="../#getting-started">Getting Started</a></li>
        <li><a href="../#modules">Modules</a></li>
        <li><a href="./">API Reference</a></li>
        <li><a href="../guides/">Guides</a></li>
        <li><a href="https://github.com/oxog/kit" target="_blank">GitHub</a></li>
      </ul>
    </div>
  </nav>

  <main class="container api-content">
    <div class="api-layout">
      <aside class="api-sidebar">
        <ul>
          <li><a href="#metrics">Metrics</a></li>
          <li><a href="#counter">Counter</a></li>
          <li><a href="#gauge">Gauge</a></li>
          <li><a href="#histogram">Histogram</a></li>
          <li><a href="#health">Health Checks</a></li>
          <li><a href="#tracing">Tracing</a></li>
        </ul>
      </aside>

      <div class="api-main">
        <div class="api-header">
          <h1>@oxog/kit/observability</h1>
          <p>Metrics, health checks, and distributed tracing</p>
        </div>

        <section class="api-section" id="metrics">
          <h2>Metrics</h2>
          <p>Application metrics with Prometheus export support</p>

          <div class="api-function">
            <h4>metrics</h4>
            <p>Default metrics instance</p>
            <pre><code>import { metrics } from '@oxog/kit/observability';

// Create metrics
const requestCounter = metrics.counter({
  name: 'http_requests_total',
  help: 'Total HTTP requests',
  labels: ['method', 'path', 'status'],
});

const activeConnections = metrics.gauge({
  name: 'active_connections',
  help: 'Number of active connections',
});

const requestDuration = metrics.histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration',
  buckets: [0.1, 0.5, 1, 2, 5],
});

// Export to Prometheus format
const output = metrics.toPrometheus();
// # HELP http_requests_total Total HTTP requests
// # TYPE http_requests_total counter
// http_requests_total{method="GET",path="/api"} 42</code></pre>
          </div>

          <div class="api-function">
            <h4>createMetrics(options?: MetricsOptions): Metrics</h4>
            <p>Create a new metrics registry</p>
            <pre><code>import { createMetrics } from '@oxog/kit/observability';

const appMetrics = createMetrics({
  prefix: 'myapp_',  // Prefix for all metric names
});</code></pre>
          </div>
        </section>

        <section class="api-section" id="counter">
          <h2>Counter</h2>
          <p>Monotonically increasing counter</p>

          <div class="api-function">
            <h4>counter.inc(labels?: Record&lt;string, string&gt;, value?: number)</h4>
            <p>Increment the counter</p>
            <pre><code>const counter = metrics.counter({
  name: 'requests_total',
  labels: ['method', 'status'],
});

// Increment by 1
counter.inc({ method: 'GET', status: '200' });

// Increment by specific value
counter.inc({ method: 'POST', status: '201' }, 5);</code></pre>
          </div>

          <div class="api-function">
            <h4>counter.get(labels?: Record&lt;string, string&gt;): number</h4>
            <p>Get current counter value</p>
          </div>

          <div class="api-function">
            <h4>counter.reset()</h4>
            <p>Reset all counter values to 0</p>
          </div>
        </section>

        <section class="api-section" id="gauge">
          <h2>Gauge</h2>
          <p>Value that can increase or decrease</p>

          <div class="api-function">
            <h4>gauge.set(labels?: Record&lt;string, string&gt;, value: number)</h4>
            <p>Set gauge to specific value</p>
            <pre><code>const gauge = metrics.gauge({
  name: 'temperature_celsius',
  labels: ['location'],
});

gauge.set({ location: 'server_room' }, 23.5);</code></pre>
          </div>

          <div class="api-function">
            <h4>gauge.inc(labels?: Record&lt;string, string&gt;, value?: number)</h4>
            <p>Increment gauge value</p>
          </div>

          <div class="api-function">
            <h4>gauge.dec(labels?: Record&lt;string, string&gt;, value?: number)</h4>
            <p>Decrement gauge value</p>
          </div>

          <div class="api-function">
            <h4>gauge.setToCurrentTime(labels?: Record&lt;string, string&gt;)</h4>
            <p>Set gauge to current Unix timestamp</p>
          </div>
        </section>

        <section class="api-section" id="histogram">
          <h2>Histogram</h2>
          <p>Distribution of values across buckets</p>

          <div class="api-function">
            <h4>histogram.observe(labels?: Record&lt;string, string&gt;, value: number)</h4>
            <p>Record a value observation</p>
            <pre><code>const histogram = metrics.histogram({
  name: 'request_duration_seconds',
  help: 'Request duration in seconds',
  buckets: [0.1, 0.25, 0.5, 1, 2.5, 5, 10],
  labels: ['endpoint'],
});

// Record request duration
const start = Date.now();
await handleRequest();
const duration = (Date.now() - start) / 1000;
histogram.observe({ endpoint: '/api/users' }, duration);</code></pre>
          </div>

          <div class="api-function">
            <h4>histogram.startTimer(labels?: Record&lt;string, string&gt;): () => number</h4>
            <p>Start a timer that records duration when called</p>
            <pre><code>const stopTimer = histogram.startTimer({ endpoint: '/api/users' });

await handleRequest();

const duration = stopTimer(); // Automatically observes duration</code></pre>
          </div>
        </section>

        <section class="api-section" id="health">
          <h2>Health Checks</h2>
          <p>Application health monitoring</p>

          <div class="api-function">
            <h4>createHealthChecker(options?: HealthOptions): HealthChecker</h4>
            <p>Create a health checker</p>
            <pre><code>import { createHealthChecker } from '@oxog/kit/observability';

const health = createHealthChecker();

// Register health checks
health.register('database', async () => {
  await db.ping();
  return { status: 'healthy' };
}, { critical: true, timeout: 5000 });

health.register('cache', async () => {
  const latency = await redis.ping();
  return {
    status: latency < 100 ? 'healthy' : 'degraded',
    latency,
  };
});

// Run all checks
const report = await health.check();
// {
//   status: 'healthy',
//   checks: {
//     database: { status: 'healthy', duration: 15 },
//     cache: { status: 'healthy', duration: 8, latency: 8 }
//   }
// }

// Use in HTTP endpoint
app.get('/health', async (req, res) => {
  const report = await health.check();
  res.status(report.status === 'healthy' ? 200 : 503).json(report);
});</code></pre>
          </div>

          <div class="api-function">
            <h4>health.register(name: string, check: HealthCheck, options?: CheckOptions)</h4>
            <p>Register a health check</p>
            <dl class="params">
              <dt>name</dt>
              <dd>Unique name for the check</dd>
              <dt>check</dt>
              <dd>Async function returning health status</dd>
              <dt>options.critical</dt>
              <dd>If true, failure marks overall status as unhealthy</dd>
              <dt>options.timeout</dt>
              <dd>Timeout in milliseconds</dd>
            </dl>
          </div>

          <div class="api-function">
            <h4>health.unregister(name: string)</h4>
            <p>Remove a health check</p>
          </div>

          <div class="api-function">
            <h4>health.check(): Promise&lt;HealthReport&gt;</h4>
            <p>Run all health checks and return report</p>
          </div>

          <div class="api-function">
            <h4>Predefined Checks</h4>
            <p>Built-in health checks</p>
            <pre><code>import { checks } from '@oxog/kit/observability';

// HTTP endpoint check
health.register('api', checks.http({
  url: 'https://api.example.com/health',
  timeout: 5000,
}));

// Memory usage check
health.register('memory', checks.memory({
  maxHeapUsedPercent: 90,
}));

// Disk space check
health.register('disk', checks.disk({
  path: '/',
  minFreePercent: 10,
}));</code></pre>
          </div>
        </section>

        <section class="api-section" id="tracing">
          <h2>Tracing</h2>
          <p>Distributed tracing with W3C Trace Context support</p>

          <div class="api-function">
            <h4>createTracer(options?: TracerOptions): Tracer</h4>
            <p>Create a tracer</p>
            <pre><code>import { createTracer, ConsoleExporter } from '@oxog/kit/observability';

const tracer = createTracer({
  serviceName: 'my-service',
  exporter: new ConsoleExporter(),
});

// Create a span
const span = tracer.startSpan('http-request', {
  attributes: {
    'http.method': 'GET',
    'http.url': '/api/users',
  },
});

try {
  const result = await handleRequest();
  span.setStatus('ok');
  return result;
} catch (error) {
  span.setStatus('error', error.message);
  span.recordException(error);
  throw error;
} finally {
  span.end();
}</code></pre>
          </div>

          <div class="api-function">
            <h4>span.startSpan(name: string, options?: SpanOptions): Span</h4>
            <p>Create a child span</p>
            <pre><code>const parentSpan = tracer.startSpan('request');

// Child span automatically linked to parent
const dbSpan = parentSpan.startSpan('database-query', {
  attributes: { 'db.statement': 'SELECT * FROM users' },
});
await db.query('SELECT * FROM users');
dbSpan.end();

parentSpan.end();</code></pre>
          </div>

          <div class="api-function">
            <h4>span.setAttribute(key: string, value: any)</h4>
            <p>Set span attribute</p>
          </div>

          <div class="api-function">
            <h4>span.addEvent(name: string, attributes?: Record&lt;string, any&gt;)</h4>
            <p>Add event to span timeline</p>
            <pre><code>span.addEvent('cache-miss', { key: 'user:123' });</code></pre>
          </div>

          <div class="api-function">
            <h4>span.setStatus(status: 'ok' | 'error', message?: string)</h4>
            <p>Set span status</p>
          </div>

          <div class="api-function">
            <h4>span.recordException(error: Error)</h4>
            <p>Record exception details on span</p>
          </div>

          <div class="api-function">
            <h4>propagation.inject / extract</h4>
            <p>W3C Trace Context propagation</p>
            <pre><code>import { propagation } from '@oxog/kit/observability';

// Inject context into headers for outgoing request
const headers = {};
propagation.inject(span.context, headers);
// headers: { traceparent: '00-xxx-yyy-01', tracestate: '...' }

// Extract context from incoming request
const context = propagation.extract(req.headers);
const span = tracer.startSpan('handler', { parent: context });</code></pre>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>@oxog/kit - MIT License</p>
    </div>
  </footer>

  <script src="../js/main.js"></script>
</body>
</html>
